<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>FPC Hit Rate</title>

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/custom.css">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/solarized-dark.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<!-- 1. Cover -->
				<section data-markdown data-background="images/2008-07-16_IMGP7587.jpg" style="color: white;">
					<script type="text/template">
						<div class="cover-content">
						<h2>Monitoring (and improving) your Full Page Cache Hit Rate</h2>
						<h4>with `Enterprise_PageCache`</h4>
						</div>
					</script>
					<aside class="notes">
				        The topic of today's talk is Monitoring (and improving) your Full Page Cache hit rate. The talk focuses heavily caching via Magento 1.X Enterprise Edition's Enterprise_PageCache module, but many of the concepts are applicable with other caching backend or even other uses cases besides page cache.
				    </aside>
				</section>
				<!-- 2. Who am I? -->
				<section data-markdown>
					<script type="text/template">
						## Who am I?
						<ul>
						<li class="fragment">Magento Developer at Something Digital (Magento Gold Solution Partner)</li>
						<li class="fragment">Oversee operations and site performance for Rite Aid, Fortune 500 company and winner of Imagine 2016 growth award</li>
						<li class="fragment">Passionate about monitoring tools and performance optimization</li>
						</ul>
					</script>
				</section>
				<!-- 3. What will we be talking about -->
				<section data-markdown>
					<script type="text/template">
						## Agenda
						<ul>
						<li class="fragment">Background
							<ul>
								<li class="fragment">What is "Full Page Cache"?</li>
								<li class="fragment">Why does it matter?</li>
								<li class="fragment">Why should we track it?</li>
							</ul>
						</li>
						<li class="fragment">`Enterprise_PageCache` Internals
							<ul data-not="30m">
								<li class="fragment">How do we hit it?</li>
								<li class="fragment">How does it get there in the first place?</li>
							</ul>
						</li>
						<li class="fragment">Monitoring Hit Rate
							<ul>
								<li class="fragment">How do we track it?</li>
								<li class="fragment">Where should we track it?</li>
							</ul>
						</li>
						<li class="fragment">Improving Hit Rate</li>
						<li class="fragment">Questions</li>
						</ul>
					</script>
				</section>
				<!-- 3. What is "Full Page Cache"? -->
				<section data-markdown>
					<script type="text/template">
						## What is Full Page Cache?
						<ul>
						<li class="fragment">Saving the HTML generated by a dynamic web site to be served statically on subsequent requests</li>
						</ul>
					</script>
				</section>
				<!-- 4. Why Does It Matter? -->
				<section>
					<section data-markdown>
						<script type="text/template">
						## Why Does Page Cache Matter?
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
							### Benchmarks
							<img
								src="images/benchmarks.png"
								style="width: 50%; height: auto">
							<ul>
								<li>Magento 1.14.1.0</li>
								<li>Sample data</li>
								<li>CentOS VM with 2GB RAM</li>
								<li>Men's shirts category page</li>
							</ul>
						</script>
					</section>
					<section data-markdown data-not="30m">
						<script type="text/template">
							### Benchmarks
							<p>"It typically speeds up delivery with a factor of 300 - 1000x, depending on your architecture." - https://varnish-cache.org/intro/</p>
						</script
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
							### It matters because...
							<ul>
								<li class="fragment">Speedier application improves user experience during normal operation</li>
								<li class="fragment">Critical for ensuring availability during a traffic surge</li>
							</ul>
						</script>
					</section>
				</section>
				<!-- 5. Why Should We Track? -->
				<section>
					<section data-markdown>
						<script type="text/template">
							## Why Should We Track?
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
							"If Engineering at Etsy has a religion, it’s the Church of Graphs. If it moves, we track it. Sometimes we’ll draw a graph of something that isn’t moving yet, just in case it decides to make a run for it." - https://codeascraft.com/2011/02/15/measure-anything-measure-everything/
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
							### We should track it to...
							<ul>
								<li class="fragment">Diagnose production issues</li>
								<li class="fragment">Understand if a deployment adversely affects hit rate</li>
								<li class="fragment">Review the data, optimize, rinse and repeat</li>
							</ul>
						</script>
					</section>
				</section>
				<!-- 6. How Do We Hit It? -->
				<section>
					<section data-markdown>
						<script type="text/template">
							## Agenda
							<ul class="toc">
							<li>Background
								<ul>
									<li>What is "Full Page Cache"?</li>
									<li>Why does it matter?</li>
									<li>Why should we track it?</li>
								</ul>
							</li>
							<li><span class="active">`Enterprise_PageCache` Internals</span>
								<ul data-not="30m">
									<li>How do we hit it?</li>
									<li>How does it get there in the first place?</li>
								</ul>
							</li>
							<li>Monitoring Hit Rate
								<ul>
									<li>How do we track it?</li>
									<li>Where should we track it?</li>
								</ul>
							</li>
							<li>Improving Hit Rate</li>
							<li>Questions</li>
							</ul>
						</script>
					</section>
					<section data-markdown data-not="30m">
						<script type="text/template">
							If you want to know how to monitor and improve Full Page Cache hit rate, you first need to understand how Full Page Cache works.
						</script>
					</section>
					<section data-markdown data-not="30m">
						<script type="text/template">
						## How Do We Hit It?
						</script>
					</section>
					<section data-markdown data-not="30m">
						<script type="text/template">
						## Request Flow
						<img
								class="plain"
								src="images/hitting-page-cache.svg"
								style="height: auto">
						</script>
					</section>
					<section data-markdown data-not="30m">
						<script type="text/template">
						### The moment of truth...
						```php
						// Mage_Core_Model_App::run()
						if ($this->_cache->processRequest()) {
						    $this->getResponse()->sendResponse();
						} else {
						    $this->_initModules();
						    $this->loadAreaPart(Mage_Core_Model_App_Area::AREA_GLOBAL, Mage_Core_Model_App_Area::PART_EVENTS);

						    if ($this->_config->isLocalConfigLoaded()) {
						        $this->_initCurrentStore($scopeCode, $scopeType);
						        $this->_initRequest();
						        Mage_Core_Model_Resource_Setup::applyAllDataUpdates();
						    }

						    $this->getFrontController()->dispatch();
						}
						return $this;
						```
						<img
								class="plain"
								src="images/hitting-page-cache-1.svg"
								style="height: auto">
						</script>
					</section>
					<section data-markdown data-not="30m">
						<script type="text/template">
						### Processing the request
						```php
						// Mage_Core_Model_Cache::processRequest()
						$content = false;
						foreach ($this->_requestProcessors as $processor) {
						    $processor = $this->_getProcessor($processor);
						    if ($processor) {
						        $content = $processor->extractContent($content);
						    }
						}

						if ($content) {
						    Mage::app()->getResponse()->appendBody($content);
						    return true;
						}
						return false;
						```
						<img
								class="plain"
								src="images/hitting-page-cache-2.svg"
								style="height: auto">
						</script>
					</section>
					<section data-markdown data-not="30m">
						<script type="text/template">
						### Extracting Content
						```php
						// Enterprise_PageCache_Model_Processor::extractContent()
						$subprocessorClass = $this->getMetadata('cache_subprocessor');
						if (!$subprocessorClass) {
						    return $content;
						}

						$subprocessor = new $subprocessorClass;
						$cacheId = $this->prepareCacheId($subprocessor->getPageIdWithoutApp($this));

						$content = $cacheInstance->load($cacheId);

						if ($content) {
						    $content = $this->_processContent($content);
						}

						return $content;
						```
						<img
								data-not="30m"
								class="plain"
								src="images/hitting-page-cache-3.svg"
								style="height: auto">
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
						### The `requestCacheId`
						```php
						// Enterprise_PageCache_Model_Processor::_createRequestIds()
						$uri = $this->_getFullPageUrl();

						//Removing get params
						$pieces = explode('?', $uri);
						$uri = array_shift($pieces);

						if (isset($_COOKIE[Mage_Core_Model_Store::COOKIE_NAME])) {
						    $uri = $uri.'_'.$_COOKIE[Mage_Core_Model_Store::COOKIE_NAME];
						}
						if (isset($_COOKIE['currency'])) {
						    $uri = $uri.'_'.$_COOKIE['currency'];
						}
						if (isset($_COOKIE[Enterprise_PageCache_Model_Cookie::COOKIE_CUSTOMER_GROUP])) {
						    $uri .= '_' . $_COOKIE[Enterprise_PageCache_Model_Cookie::COOKIE_CUSTOMER_GROUP];
						}
						if (isset($_COOKIE[Enterprise_PageCache_Model_Cookie::COOKIE_CUSTOMER_LOGGED_IN])) {
						    $uri .= '_' . $_COOKIE[Enterprise_PageCache_Model_Cookie::COOKIE_CUSTOMER_LOGGED_IN];
						}
						if (isset($_COOKIE[Enterprise_PageCache_Model_Cookie::CUSTOMER_SEGMENT_IDS])) {
						    $uri .= '_' . $_COOKIE[Enterprise_PageCache_Model_Cookie::CUSTOMER_SEGMENT_IDS];
						}
						if (isset($_COOKIE[Enterprise_PageCache_Model_Cookie::IS_USER_ALLOWED_SAVE_COOKIE])) {
						    $uri .= '_' . $_COOKIE[Enterprise_PageCache_Model_Cookie::IS_USER_ALLOWED_SAVE_COOKIE];
						}
						if (Enterprise_PageCache_Helper_Data::isSSL()) {
						    $uri .= '_ssl';
						}
						$designPackage = $this->_getDesignPackage();

						if ($designPackage) {
						    $uri .= '_' . $designPackage;
						}

						$this->_requestId = $uri;
						$this->_requestCacheId = $this->prepareCacheId($this->_requestId);
						```
						<img
								data-not="30m"
								class="plain"
								src="images/hitting-page-cache-4.svg"
								style="height: auto">
						</script>
					</section>
					<section data-markdown data-not="30m">
						<script type="text/template">
						### The subprocessor gets a say too!
						```php
						// Enterprise_PageCache_Model_Processor_Default::getPageIdWithoutApp()
						$queryParams = $_GET;
						ksort($queryParams);
						$queryParamsHash = md5(serialize($queryParams));
						return $processor->getRequestId() . '_' . $queryParamsHash;
						```
						<img
								data-not="30m"
								class="plain"
								src="images/hitting-page-cache-5.svg"
								style="height: auto">
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
						<h3 data-not="30m">The second moment of truth...</h3>
						<h3 data-is="30m">Filling in holes</h3>
						```php
						// Enterprise_PageCache_Model_Processor::_processContent()
						$containers = $this->_processContainers($content);
						$isProcessed = empty($containers);

						if ($isProcessed) {
						    return $content;
						} else {
						    Mage::register('cached_page_content', $content);
						    Mage::register('cached_page_containers', $containers);
						    Mage::app()->getRequest()
						        ->setModuleName('pagecache')
						        ->setControllerName('request')
						        ->setActionName('process')
						        ->isStraight(true);

						    return false;
						}
						```
						<img
								data-not="30m"
								class="plain"
								src="images/hitting-page-cache-6.svg"
								style="height: auto">
						</script>
					</section>
				</section>
				<!-- 7. How Does It Get There In The First Place? -->
				<section>
					<section data-markdown data-not="30m">
						<script type="text/template">
							## But How Does It Get There In The First Place?
						</script>
					</section>
					<section data-markdown data-not="30m">
						<script type="text/template">
						## Request Flow
						<img
								class="plain"
								src="images/getting-there.svg"
								style="height: auto">
						</script>
					</section>
					<section data-markdown data-not="30m">
						<script type="text/template">
							### Before sending the response...
							```xml
							<!-- app/code/core/Enterprise/PageCache/etc/config.xml -->
							<controller_front_send_response_before>
							    <observers>
							        <enterprise_pagecache>
							            <class>enterprise_pagecache/observer</class>
							            <method>cacheResponse</method>
							        </enterprise_pagecache>
							    </observers>
							</controller_front_send_response_before>
							```
							<img
								class="plain"
								src="images/getting-there-2.svg"
								style="height: auto">
						</script>
						</script>
					</section>
					<section data-markdown data-not="30m">
						<script type="text/template">
							### What the `Observer` does...
							```php
							// Enterprise_PageCache_Model_Observer::cacheResponse()
							if (!$this->isCacheEnabled()) {
							    return $this;
							}
							$frontController = $observer->getEvent()->getFront();
							$request = $frontController->getRequest();
							$response = $frontController->getResponse();
							$this->_processor->processRequestResponse($request, $response);
							return $this;
							```
							<img
								class="plain"
								src="images/getting-there-3.svg"
								style="height: auto">
						</script>
					</section>
					<section data-markdown data-not="30m">
						<script type="text/template">
							### The processor...
							```php
							Enterprise_PageCache_Model_Processor::processRequestResponse()
							if ($this->canProcessRequest($request)) {
							    $processor = $this->getRequestProcessor($request);
							    if ($processor && $processor->allowCache($request)) {
							        $this->setMetadata('cache_subprocessor', get_class($processor));

							        $cacheId = $this->prepareCacheId($processor->getPageIdInApp($this));
							        $content = $processor->prepareContent($response);

							        $contentSize = strlen($content);
							        $currentStorageSize = (int) $cacheInstance->load(self::CACHE_SIZE_KEY);

							        $maxSizeInBytes = Mage::getStoreConfig(self::XML_PATH_CACHE_MAX_SIZE) * 1024 * 1024;

							        if ($currentStorageSize >= $maxSizeInBytes) {
							            Mage::app()->getCacheInstance()->invalidateType('full_page');
							            return $this;
							        }

							        $cacheInstance->save($content, $cacheId, $this->getRequestTags());

							        $cacheInstance->save(
							            $currentStorageSize + $contentSize,
							            self::CACHE_SIZE_KEY,
							            $this->getRequestTags()
							        );
							        $this->_saveMetadata();
							    }
							}
							```
							<img
								data-not="30m"
								class="plain"
								src="images/getting-there-4.svg"
								style="height: auto">
						</script>
					</section>
					<section data-markdown data-is="30m">
						<script type="text/template">
							### Max Cache Size
							```php
							// Enterprise_PageCache_Model_Processor::processRequestResponse()
							$contentSize = strlen($content);
							$currentStorageSize = (int) $cacheInstance->load(self::CACHE_SIZE_KEY);

							$maxSizeInBytes = Mage::getStoreConfig(self::XML_PATH_CACHE_MAX_SIZE) * 1024 * 1024;

							if ($currentStorageSize >= $maxSizeInBytes) {
								Mage::app()->getCacheInstance()->invalidateType('full_page');
								return $this;
							}

							$cacheInstance->save($content, $cacheId, $this->getRequestTags());

							$cacheInstance->save(
								$currentStorageSize + $contentSize,
								self::CACHE_SIZE_KEY,
								$this->getRequestTags()
							);
							```
						</script>
					</section>
					<section data-markdown data-not="30m">
						<script type="text/template">
							### Can we process the request?
							```php
							// Enterprise_PageCache_Model_Processor::canProcessRequest()
							$res = $this->isAllowed();
							$res = $res && Mage::app()->useCache('full_page');
							if ($request->getParam('no_cache')) {
							    $res = false;
							}

							if ($res) {
							    $maxDepth = Mage::getStoreConfig(self::XML_PATH_ALLOWED_DEPTH);
							    $queryParams = $request->getQuery();
							    unset($queryParams[Enterprise_PageCache_Model_Cache::REQUEST_MESSAGE_GET_PARAM]);
							    $res = count($queryParams)<=$maxDepth;
							}
							if ($res) {
							    $multicurrency = Mage::getStoreConfig(self::XML_PATH_CACHE_MULTICURRENCY);
							    if (!$multicurrency && !empty($_COOKIE['currency'])) {
							        $res = false;
							    }
							}
							return $res;
							```
							<img
								data-not="30m"
								class="plain"
								src="images/getting-there-5.svg"
								style="height: auto">
						</script>
					</section>
					<section data-markdown data-is="30m">
						<script type="text/template">
							### Max depth
							```php
							// Enterprise_PageCache_Model_Processor::canProcessRequest()
							$maxDepth = Mage::getStoreConfig(self::XML_PATH_ALLOWED_DEPTH);
							$queryParams = $request->getQuery();
							unset($queryParams[Enterprise_PageCache_Model_Cache::REQUEST_MESSAGE_GET_PARAM]);
							$res = count($queryParams)<=$maxDepth;

							return $res;
							```
						</script>
					</section>
					<section data-markdown data-not="30m">
						<script type="text/template">
							### Are we allowed?
							```php
							// Enterprise_PageCache_Model_Processor::isAllowed()
							if (!$this->_requestId) {
							    return false;
							}
							if (isset($_COOKIE['NO_CACHE'])) {
							    return false;
							}
							if (isset($_GET['no_cache'])) {
							    return false;
							}
							if (isset($_GET[Mage_Core_Model_Session_Abstract::SESSION_ID_QUERY_PARAM])) {
							    return false;
							}
							if (!Mage::app()->useCache('full_page')) {
							    return false;
							}

							return true;
							```
							<img
								class="plain"
								src="images/getting-there-6.svg"
								style="height: auto">
						</script>
					</section>
					<section data-markdown data-not="30m">
						<script type="text/template">
							### Getting the `_requestProcessor`
							```php
							// Enterprise_PageCache_Model_Processor::getRequestProcessor()
							$configuration = Mage::getConfig()->getNode(self::XML_NODE_ALLOWED_CACHE);
							$module = $request->getModuleName();
							$action = $request->getActionName();
							if (strtolower($action) == self::NOT_FOUND_ACTION && isset($configuration['_no_route'])) {
							    $model = $configuration['_no_route'];
							} elseif (isset($configuration[$module])) {
							    $model = $configuration[$module];
							    $controller = $request->getControllerName();
							    if (is_array($configuration[$module]) && isset($configuration[$module][$controller])) {
							        $model = $configuration[$module][$controller];
							        if (is_array($configuration[$module][$controller])
							                && isset($configuration[$module][$controller][$action])) {
							            $model = $configuration[$module][$controller][$action];
							        }
							    }
							}
							if (isset($model) && is_string($model)) {
							    $this->_requestProcessor = Mage::getModel($model);
							}
							```
							<img
								class="plain"
								src="images/getting-there-7.svg"
								style="height: auto">
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
							### `_requestProcessor` Config
							```xml
							<!-- app/code/core/Enterprise/PageCache/etc/config.xml -->
							<cache>
							    <requests>
							        <_no_route>enterprise_pagecache/processor_noroute</_no_route>
							        <cms>enterprise_pagecache/processor_default</cms>
							        <catalog>
							            <category>
							                <view>enterprise_pagecache/processor_category</view>
							            </category>
							        </catalog>
							        <catalog>
							            <product>
							                <view>enterprise_pagecache/processor_product</view>
							            </product>
							        </catalog>
							    </requests>
							</cache>
							```
							<img
								data-not="30m"
								class="plain"
								src="images/getting-there-7.svg"
								style="height: auto">
						</script>
					</section>
					<section data-markdown data-not="30m">
						<script type="text/template">
							### The `_requestProcessor`'s say
							```php
							// Enterprise_PageCache_Model_Processor_Default::allowCache()
							foreach ($this->_noCacheGetParams as $param) {
							    if (!is_null($request->getParam($param, null))) {
							        $this->_allowCache = false;
							        return $this->_allowCache;
							    }
							}
							if (Mage::getSingleton('core/session')->getNoCacheFlag()) {
							    $this->_allowCache = false;
							    return $this->_allowCache;
							}
							$this->_allowCache = true;
							```
							<img
								class="plain"
								src="images/getting-there-8.svg"
								style="height: auto">
						</script>
					</section>
				</section>
				<!-- 8. How Do We Track It? -->
				<section>
					<section data-markdown>
						<script type="text/template">
							## Agenda
							<ul class="toc">
							<li>Background
								<ul>
									<li>What is "Full Page Cache"?</li>
									<li>Why does it matter?</li>
									<li>Why should we track it?</li>
								</ul>
							</li>
							<li>`Enterprise_PageCache` Internals
								<ul data-not="30m">
									<li>How do we hit it?</li>
									<li>How does it get there in the first place?</li>
								</ul>
							</li>
							<li><span class="active">Monitoring Hit Rate</span>
								<ul>
									<li>How do we track it?</li>
									<li>Where should we track it?</li>
								</ul>
							</li>
							<li>Improving Hit Rate</li>
							<li>Questions</li>
							</ul>
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
							## How Do We Track It?
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
							### I built a (free) module
							<img
								src="images/Mpchadwick_PageCacheHitRate.png"
								style="width: 70%; height: auto">
							<p class="smaller">https://github.com/mpchadwick/Mpchadwick_PageCacheHitRate</p>
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
							### Three Types of Responses...
							<ul>
							<li class="fragment">**Hits** - The document and all containers could be pulled from cache.</li>
							<li class="fragment">**Partial Hits** - The document could be pulled from cache, however there were containers that needed additional processing.</li>
							<li class="fragment">**Misses** - The document could not be pulled from cache.</li>
							</ul>
						</script>
					</section>
					<section data-markdown data-not="30m">
						<script type="text/template">
							### Tracking Hits With A `requestProcessor`
							```php
							// Mpchadwick_PageCacheHitRate_Model_Processor::extractContent()
							if (!$content) {
							    // Bail, this is a miss
							    return $content;
							}

							// This is a hit, track it
							```
						</script>
					</section>
					<section data-markdown data-not="30m">
						<script type="text/template">
							### Tracking Partials and Misses with an `Observer`
							```xml
							<!-- app/code/community/Mpchadwick/PageCacheHitRate/etc/config.xml -->
							<controller_front_send_response_before>
							    <observers>
							        <mpchadwick_pagecachehitrate>
							            <class>Mpchadwick_PageCacheHitRate_Model_Observer</class>
							            <method>handleControllerFrontSendResponseBefore</method>
							        </mpchadwick_pagecachehitrate>
							    </observers>
							</controller_front_send_response_before>
							```
						</script>
					</section>
					<section data-markdown data-not="30m">
						<script type="text/template">
							### Executing the track
							```php
							// Mpchadwick_PageCacheHitRate_Model_Observer::handleControllerFrontSendResponseBefore()
							$paramProvider = Mage::getModel('mpchadwick_pagecachehitrate/tracker_paramProvider');
							$type = $this->type();
							$params = $paramProvider->baseParams(true) + array(
							    'type' => $type,
							    'route' => $this->trackerRoute(),
							);

							$factory = Mage::getModel('mpchadwick_pagecachehitrate/trackerFactory');
							foreach ($trackers->asArray() as $alias => $data) {
							    $tracker = $factory->build($data['class']);
							    $tracker->track('RequestResponse', $params, $alias);

							    // Track any container misses for a partial cache response
							    $trackContainerMisses = (string)$config->get('track_container_misses');
							    if ($type === 'partial' && $trackContainerMisses) {
							        unset($params['type']);
							        $tracker->trackContainerMisses($params);
							    }
							}
							```
						</script>
					</section>
					<section data-markdown data-not="30m">
						<script type="text/template">
							### Partial Hit or Miss?
							```php
							// Mpchadwick_PageCacheHitRate_Model_Observer::type()
							$request = Mage::app()->getRequest();

							if ($request->getModuleName() === 'pagecache' &&
							    $request->getControllerName() === 'request' &&
							    $request->getActionName() === 'process'
							) {
							    return 'partial';
							} else {
							    return 'miss';
							}
							```
						</script>
					</section>
					<section data-markdown data-not="30m">
						<script type="text/template">
							### Tracking Container Misses
							```php
							// Mpchadwick_PageCacheHitRate_Model_Tracker_Abstract::trackContainerMisses()
							$containers = Mage::registry('cached_page_containers');

							foreach ($containers as $container) {
							    $this->track('ContainerMiss', $params + array(
							        'container' => get_class($container),
							    ));
							}
							```
						</script>
					</section>
					<section data-markdown data-not="30m">
						<script type="text/template">
							### Dimensions to Track
							```php
							Mpchadwick_PageCacheHitRate_Model_Tracker_ParamProvider::baseParams()
							return array(
							    'url' => $this->getUrl($originalRequest),
							    'ip' => Mage::app()->getRequest()->getClientIp(),
							    'hostname' => gethostname(),
							    'customerGroup' => $this->getCustomerGroup(),
							    'userAgent' => $this->userAgent,
							    'isBot' => $this->isBot,
							);
							```
						</script>
					</section>
					<section data-markdown data-is="30m">
						<script type="text/template">
							### Other Features
							<ul>
                            <li class="fragment">Track container misses</li>
                            <li class="fragment">Additional dimensions
								<ul>
										<li class="fragment">Route</li>
										<li class="fragment">Is Bot?</li>
										<li class="fragment">IP Address</li>
										<li class="fragment">Hostname</li>
									</ul>
                            </li>
                            <li class="fragment">Extendable API</li>
                            </ul>
						</script>
					</section>
				</section>
				<!-- 9. Where Should We Track It? -->
				<section>
					<section data-markdown>
						<script type="text/template">
						## Where Should We Keep Track?
						<ul>
							<li class="fragment">**File** - Useful for local profiling. Not intended for long term production use.</li>
							<li class="fragment">**New Relic** - SaaS. Can store high cardinality data. **Insights not hooked up to alerting**</li>
							<li class="fragment">**Redis** - Temporary storage intended to be scraped and stored elsewhere in time series.</li>
							<li class="fragment">**Other** - `Mpchadwick_PageCacheHitRate` allows you to keep track of you hit rate however you'd like by implementing an interface</li>
						</ul>
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
							### Open Source Time Series Databases
							<ul>
								<li class="fragment">**InfluxDB**
									<ul>
										<li class="fragment">HTTP endpoint accepts writes (and other queries)</li>
										<li class="fragment">Measurements, tags and fields</li>
										<li class="fragment">Visualization via Grafana or Cronograf</li>
										<li class="fragment">Alerting via Kapacitor</li>
										<li class="fragment">Retention Policies</li>
										<li class="fragment">Continuous Queries</li>
										<li class="fragment">Written in Go</li>
										<li class="fragment">Need to be mindful of series cardinality</li>
									</ul>
								</li>
							</ul>
						</script>
					</section>
					<section data-markdown data-not="30m">
						<script type="text/template">
							### Open Source Time Series Databases
							<ul>
								<li class="fragment">**Prometheus**
									<ul>
										<li class="fragment">Sends HTTP request to pull in metrics from "targets"</li>
										<li class="fragment">Metrics, labels and values</li>
										<li class="fragment">Visualization via Grafana or PromDash</li>
										<li class="fragment">Alerting via AlertManager</li>
										<li class="fragment">Also written in Go</li>
										<li class="fragment">Also need to be mindful of series cardinality</li>
									</ul>
								</li>
							</ul>
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
							### SomethingDigital_InfluxDb
							<img
								src="images/SomethingDigital_InfluxDb.png"
								style="width: 70%; height: auto">
							<p class="smaller">https://github.com/sdinteractive/SomethingDigital_InfluxDb</p>
						</script>
					</section>
				</section>
                <!-- 10. How Can We Improve our Hit Rate? -->
                <section>
                    <section data-markdown>
						<script type="text/template">
							## Agenda
							<ul class="toc">
							<li>Background
								<ul>
									<li>What is "Full Page Cache"?</li>
									<li>Why does it matter?</li>
									<li>Why should we track it?</li>
								</ul>
							</li>
							<li>`Enterprise_PageCache` Internals
								<ul data-not="30m">
									<li>How do we hit it?</li>
									<li>How does it get there in the first place?</li>
								</ul>
							</li>
							<li>Monitoring Hit Rate
								<ul>
									<li>How do we track it?</li>
									<li>Where should we track it?</li>
								</ul>
							</li>
							<li class="active">Improving Hit Rate</li>
							<li>Questions</li>
							</ul>
						</script>
					</section>
                    <section data-markdown>
                        <script type="text/template">
                            ## How Can We Improve Our Hit Rate?
                        </script>
                    </section>
                    <section data-markdown>
                        <script type="text/template">
                            ### Have you ever seen a URL that looks like this?
                            <p class="fragment">http://www.example.com?gclid=uniqueidentifier</p>
                        </script>
                    </section>
                    <section data-markdown>
                        <script type="text/template">
                            ### How about this?
                             <p class="fragment">http://www.example.com?utm_medium=email&utm_campgain=my-camapaign&utm_content=link-1</p>
                        </script>
                    </section>
                    <section data-markdown>
                        <script type="text/template">
							<h3 data-not="30m">Recall this...</h3>
							<h3 data-is="30m">Query Param Influence</h3>
							```php
							// Enterprise_PageCache_Model_Processor_Default::getPageIdWithoutApp()
							$queryParams = $_GET;
							ksort($queryParams);
							$queryParamsHash = md5(serialize($queryParams));
							return $processor->getRequestId() . '_' . $queryParamsHash;
                            ```
                        </script>
                    </section>
                    <section data-markdown>
                        <script type="text/template">
                            <h3 data-not="30m">Also, recall this...</h3>
							<h3 data-is="30m">Max Depth</h3>
                            ```php
                            // Enterprise_PageCache_Model_Processor_Default::canProcessRequest()
                            $maxDepth = Mage::getStoreConfig(self::XML_PATH_ALLOWED_DEPTH);
                            $queryParams = $request->getQuery();
                            unset($queryParams[Enterprise_PageCache_Model_Cache::REQUEST_MESSAGE_GET_PARAM]);
                            $res = count($queryParams)<=$maxDepth;
                            ```
                        </script>
                    </section>
                    <section data-markdown>
                        <script type="text/template">
                            ### Something I didn't show you...
                            ```xml
                            <!-- app/code/core/Enterprise/PageCache/etc/config.xml -->
                            <default>
                                <system>
                                    <page_cache>
                                        <allowed_depth>1</allowed_depth>
                                    </page_cache>
                                </system>
                            </default>
                            ```
                        </script>
                    </section>
                    <section data-markdown>
                        <script type="text/template">
                            ### 2 **Easy** Tricks
                            <ul>
                                <li class="fragment">Strip parameters that aren't needed on the server</li>
                                <li class="fragment">Increase Max Depth</li>
                            </ul>
                        </script>
                    </section>
                    <section data-markdown>
                        <script type="text/template">
                            ### Another Free Module
                            <img
								src="images/SomethingDigital_PageCacheParams.png"
								style="width: 70%; height: auto">
							<p class="smaller">https://github.com/sdinteractive/SomethingDigital_PageCacheParams</p>
                        </script>
                    </section>
                    <section data-markdown>
                        <script type="text/template">
                            ### A script to help you identify which params to strip
                            <img
								src="images/query-string-usage.png"
								style="width: 70%; height: auto">
							<p class="smaller">https://gist.github.com/mpchadwick/6c2313eda1ec6d42c8b97ed70fc5a55f</p>
                        </script>
                    </section>
                    <section data-markdown data-not="30m">
						<script type="text/template">
						### Personalization vs performance
						```php
						// Enterprise_PageCache_Model_Processor::_createRequestIds()
						if (isset($_COOKIE[Enterprise_PageCache_Model_Cookie::COOKIE_CUSTOMER_GROUP])) {
						    $uri .= '_' . $_COOKIE[Enterprise_PageCache_Model_Cookie::COOKIE_CUSTOMER_GROUP];
						}
						if (isset($_COOKIE[Enterprise_PageCache_Model_Cookie::COOKIE_CUSTOMER_LOGGED_IN])) {
						    $uri .= '_' . $_COOKIE[Enterprise_PageCache_Model_Cookie::COOKIE_CUSTOMER_LOGGED_IN];
						}
						if (isset($_COOKIE[Enterprise_PageCache_Model_Cookie::CUSTOMER_SEGMENT_IDS])) {
						    $uri .= '_' . $_COOKIE[Enterprise_PageCache_Model_Cookie::CUSTOMER_SEGMENT_IDS];
						}
						```
						</script>
					</section>
					<section data-markdown data-not="30m">
						<script type="text/template">
						### Other compromises
						<ul>
							<li class="fragment">Size of catalog</li>
							<li class="fragment">Number of categories</li>
							<li class="fragment">Number of attributes / attribute values</li>
						</ul>
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
						### Uncached Routes
						<ul>
							<li class="fragment">Search results page</li>
							<li class="fragment">Some random SEO plugin?</li>
						</ul>
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
						### No cache containers
						```xml
						<!-- app/code/community/My/Module/etc/cache.xml-->
						<?xml version="1.0"?>
						<config>
						    <placeholders>
						        <my_placeholder>
						            <block>my_module/my_block</block>
						            <name>my.module</name>
						            <template>my/module/template.phtml</template>
						            <placeholder>MY_MODULE</placeholder>
						            <container>My_Module_Model_Container_Mine</container>
						            <cache_lifetime>false</cache_lifetime>
						        </my_placeholder>
						    </placeholders>
						</config>

						<!-- app/design/frontend/base/default/layout/my/module/layout.xml -->
						<?xml version="1.0"?>
						<layout version="0.1.0">
						    <default>
						        <reference name="before_body_end">
						            <block type="my_module/my_block" name="my.block" as="my_block">
						                <action method="setTemplate">
						                    <template>my/module/template.phtml</template>
						                </action>
						            </block>
						        </reference>
						    </default>
						</layout>
						```
						</script>
					</section>
					<section data-markdown>
                        <script type="text/template">
                            ### One More Free Module!
                            <img
								src="images/SomethingDigital_PageCacheUtils.png"
								style="width: 70%; height: auto">
							<p class="smaller">https://github.com/sdinteractive/SomethingDigital_PageCacheUtils</p>
                        </script>
                    </section>
                    <section data-markdown data-not="30m">
                        <script type="text/template">
                            ### Impact of admin activity...
                            <ul>
							<li class="fragment">Bulk catalog updates</li>
							<li class="fragment">Trigger happy admins</li>
						</ul>
                        </script>
                    </section>
                    <section data-markdown data-transition="zoom" data-not="30m">
                        <script type="text/template">
                            ### Cache Backend Tuning
                            <img
								src="images/twitter-result.png"
								style="width: 70%; height: auto">
                            <p class="smaller">https://twitter.com/maxpchadwick/status/751404484702638080</p>
                        </script>
                    </section>
                    <section data-markdown data-transition="zoom" data-not="30m">
                        <script type="text/template">
                            ### Cache Backend Tuning
                            <ul>
                            <li class="fragment">Set up a separate Redis instance</li>
                            <li class="fragment">Set `maxmemory` appropriately</li>
                            <li class="fragment">Understand that FPC doesn't expire</li>
                            <li class="fragment">Understand `maxmemory-policy`</li>
                            <li class="fragment">Understand `maxmemory-samples`</li>
                            <li class="fragment">Upgrade Redis!</li>
                            </ul>
                        </script>
                    </section>
                    <section data-markdown>
                        <script type="text/template">
                            ### Max. Cache Size
                            ```xml
                            <!-- app/code/core/Enterprise/PageCache/etc/config.xml -->
                            <default>
                                <system>
                                    <page_cache>
                                        <max_cache_size>1024</max_cache_size>
                                    </page_cache>
                                </system>
                            </default>
                            ```
                            <p data-is="30m" class="fragment">Set a TTL on keys and refresh on access</p>
                        </script>
                    </section>
                    <section data-markdown>
                        <script type="text/template">
                            ### Cache Warming
                        </script>
                    </section>
                    <section data-markdown data-not="30m">
                        <script type="text/template">
                            ### Recap
                            <ul>
	                            <li class="fragment">Strip unnecessary query params on the server</li>
	                            <li class="fragment">Increase max depth setting</li>
	                            <li class="fragment">Replace / customize non-FPC compatible 3rd party modules</li>
	                            <li class="fragment">Cache **all** containers</li>
	                            <li class="fragment" data-not="30m">Compromise with marketing team</li>
	                            <li class="fragment" data-not="30m">Compromise with merchandising team</li>
	                            <li class="fragment" data-not="30m">Limit admin activity</li>
	                            <li class="fragment" data-not="30m">Tune your FPC backend</li>
	                            <li class="fragment">Tune the Max. Cache Size setting</li>
	                            <li class="fragment">Consider if warming the cache would help</li>
	                        </ul>
                        </script>
                    </section>
                </section>
                <!-- 11. Questions? -->
                <section>
                    <section data-markdown>
                        <script type="text/template">
                            ## Questions?
                        </script>
                    </section>
                 </section>
                 <!-- 11. Thank you! -->
                <section>
                    <section data-markdown>
                        <script type="text/template">
                            ## Thank you!
                            <br>
                            <br>
                            <p class="smaller">http://maxchadwick.xyz/<br>
                            https://github.com/mpchadwick<br>
                            https://twitter.com/maxpchadwick</p>
                        </script>
                    </section>
                 </section>
			</div>
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>
			// More info https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				history: true,

				// More info https://github.com/hakimel/reveal.js#dependencies
				dependencies: [
					{ src: 'plugin/markdown/marked.js' },
					{ src: 'plugin/markdown/markdown.js' },
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
				]
			});

			Reveal.addEventListener('ready', function(event) {
				var q = window.location.search;
				if (q) {
					var mode = q.split('?mode=')[1];
					var hide = document.querySelectorAll('[data-not="' + mode + '"]');
					Array.prototype.forEach.call(hide, function(node) {
						node.parentNode.removeChild(node);
					});

					var show = document.querySelectorAll('[data-is="' + mode + '"]');
					Array.prototype.forEach.call(show, function(node) {
						console.log(node.style.display);
						node.style.display = "initial";
					});
				}
			})
		</script>
	</body>
</html>
