<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>FPC Hit Rate</title>

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/simple.css">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<!-- 1. Cover -->
				<section data-markdown>
					<script type="text/template">
						## Monitoring (and improving) your Full Page Cache hit rate
						#### with `Enterprise_PageCache`
					</script>
				</section>
				<!-- 2. Who am I? -->
				<section data-markdown>
					<script type="text/template">
						## Who am I?
						<ul>
						<li class="fragment">Magento Developer with Something Digital (Magento Gold Solution Partner)</li>
						<li class="fragment">Oversee operations and site performance on Rite Aid, fortune 500 company and winner of Imagine 2016 growth award</li>
						<li class="fragment">Passionate about monitoring tools and performance optimization</li>
						<ul>
							<li class="fragment">Contributor to Prometheus time series database project</li>
							<li class="fragment">Researched and published work around optimizing `/catalogsearch/result/index`</li>
							<li class="fragment">Built Domain Clamp - SaaS tool for monitoring / notifications of Domain and SSL certificates</li>
						</ul>
						</ul>
					</script>
				</section>
				<!-- 3. Why Does It Matter? -->
				<section>
					<section data-markdown>
						<script type="text/template">
						## Why Does It Matter?
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
							## Benchmarks
							<img
								src="images/Shirts_-_Men_and_Shirts_-_Men.png"
								style="width: 70%; height: auto">
							<ul>
								<li>Magento 1.14.1.0</li>
								<li>Sample data</li>
								<li>CentOS VM with 2GB RAM</li>
								<li>Men's shirt's category page</li>
							</ul>
						</script>
					</section>
				</section>
				<!-- 4. How Do We Hit It? -->
				<section>
					<section data-markdown>
						<script type="text/template">
						## How Do We Hit It?
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
						### The moment of truth...
						```php
						// Mage_Core_Mode_App::run()
						if ($this->_cache->processRequest()) {
						    $this->getResponse()->sendResponse();
						} else {
						    $this->_initModules();
						    $this->loadAreaPart(Mage_Core_Model_App_Area::AREA_GLOBAL, Mage_Core_Model_App_Area::PART_EVENTS);

						    if ($this->_config->isLocalConfigLoaded()) {
						        $this->_initCurrentStore($scopeCode, $scopeType);
						        $this->_initRequest();
						        Mage_Core_Model_Resource_Setup::applyAllDataUpdates();
						    }

						    $this->getFrontController()->dispatch();
						}
						return $this;
						```
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
						### How `Mage_Core_Model_Cache` tries to `processRequest()`
						```php
						// Mage_Core_Model_Cache::processRequest()
						$content = false;
						foreach ($this->_requestProcessors as $processor) {
						    $processor = $this->_getProcessor($processor);
						    if ($processor) {
						        $content = $processor->extractContent($content);
						    }
						}

						if ($content) {
						    Mage::app()->getResponse()->appendBody($content);
						    return true;
						}
						return false;
						```
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
						### How `Enterprise_PageCache` tries to `extractContent()`...
						```php
						// Enterprise_PageCache_Model_Processor::extractContent()
						$subprocessorClass = $this->getMetadata('cache_subprocessor');
						if (!$subprocessorClass) {
						    return $content;
						}

						$subprocessor = new $subprocessorClass;
						$cacheId = $this->prepareCacheId($subprocessor->getPageIdWithoutApp($this));

						$content = $cacheInstance->load($cacheId);

						if ($content) {
						    $content = $this->_processContent($content);
						}

						return $content;
						```
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
						### How `Enterprise_PageCache` prepares the `requestCacheId`
						```php
						// Enterprise_PageCache_Model_Processor::_createRequestIds()
						$uri = $this->_getFullPageUrl();

						//Removing get params
						$pieces = explode('?', $uri);
						$uri = array_shift($pieces);

						if (isset($_COOKIE[Mage_Core_Model_Store::COOKIE_NAME])) {
						    $uri = $uri.'_'.$_COOKIE[Mage_Core_Model_Store::COOKIE_NAME];
						}
						if (isset($_COOKIE['currency'])) {
						    $uri = $uri.'_'.$_COOKIE['currency'];
						}
						if (isset($_COOKIE[Enterprise_PageCache_Model_Cookie::COOKIE_CUSTOMER_GROUP])) {
						    $uri .= '_' . $_COOKIE[Enterprise_PageCache_Model_Cookie::COOKIE_CUSTOMER_GROUP];
						}
						if (isset($_COOKIE[Enterprise_PageCache_Model_Cookie::COOKIE_CUSTOMER_LOGGED_IN])) {
						    $uri .= '_' . $_COOKIE[Enterprise_PageCache_Model_Cookie::COOKIE_CUSTOMER_LOGGED_IN];
						}
						if (isset($_COOKIE[Enterprise_PageCache_Model_Cookie::CUSTOMER_SEGMENT_IDS])) {
						    $uri .= '_' . $_COOKIE[Enterprise_PageCache_Model_Cookie::CUSTOMER_SEGMENT_IDS];
						}
						if (isset($_COOKIE[Enterprise_PageCache_Model_Cookie::IS_USER_ALLOWED_SAVE_COOKIE])) {
						    $uri .= '_' . $_COOKIE[Enterprise_PageCache_Model_Cookie::IS_USER_ALLOWED_SAVE_COOKIE];
						}
						if (Enterprise_PageCache_Helper_Data::isSSL()) {
						    $uri .= '_ssl';
						}
						$designPackage = $this->_getDesignPackage();

						if ($designPackage) {
						    $uri .= '_' . $designPackage;
						}

						$this->_requestId = $uri;
						$this->_requestCacheId = $this->prepareCacheId($this->_requestId);
						```
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
						### The subprocessor gets a say too!
						```php
						// Enterprise_PageCache_Model_Processor_Default::getPageIdWithoutApp()
						$queryParams = $_GET;
						ksort($queryParams);
						$queryParamsHash = md5(serialize($queryParams));
						return $processor->getRequestId() . '_' . $queryParamsHash;
						```
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
						### The second moment of truth...(full hit or partial hit)
						```php
						// Enterprise_PageCache_Model_Processor_Default::_processContent()
						$containers = $this->_processContainers($content);
						$isProcessed = empty($containers);

						if ($isProcessed) {
						    return $content;
						} else {
						    Mage::register('cached_page_content', $content);
						    Mage::register('cached_page_containers', $containers);
						    Mage::app()->getRequest()
						        ->setModuleName('pagecache')
						        ->setControllerName('request')
						        ->setActionName('process')
						        ->isStraight(true);

						    // restore original routing info
						    $routingInfo = array(
						        'aliases'              => $this->getMetadata('routing_aliases'),
						        'requested_route'      => $this->getMetadata('routing_requested_route'),
						        'requested_controller' => $this->getMetadata('routing_requested_controller'),
						        'requested_action'     => $this->getMetadata('routing_requested_action')
						    );

						    Mage::app()->getRequest()->setRoutingInfo($routingInfo);
						    return false;
						}
						```
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
						### What `_processContainers()` does...
						```php
						// Enterprise_PageCache_Model_Processor_Default::_processContainers()
						$placeholders = array();
						preg_match_all(
						    Enterprise_PageCache_Model_Container_Placeholder::HTML_NAME_PATTERN,
						    $content, $placeholders, PREG_PATTERN_ORDER
						);

						$placeholders = array_unique($placeholders[1]);
						foreach ($placeholders as $definition) {
						    $placeholder = new Enterprise_PageCache_Model_Container_Placeholder($definition);
						    $container = $placeholder->getContainerClass();
						    if (!$container) {
						        continue;
						    }

						    $container = new $container($placeholder);
						    $container->setProcessor($this);

						    if (!$container->applyWithoutApp($content)) {
						        $containers[] = $container;
						    } else {
						        preg_match($placeholder->getPattern(), $content, $matches);
						        if (array_key_exists(1,$matches)) {
						            $containers = array_merge($this->_processContainers($matches[1]), $containers);
						            $content = preg_replace($placeholder->getPattern(), str_replace('$', '\\$', $matches[1]), $content);
						        }
						    }
						}
						return $containers;
						```
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
						### How containers try to `applyWithoutApp()`
						```php
						// Enterprise_PageCache_Model_Container_Abstract::applyWithoutApp()
						$cacheId = $this->_getCacheId();

						if ($cacheId === false) {
						    $this->_applyToContent($content, '');
						    return true;
						}

						$block = $this->_loadCache($cacheId);
						if ($block === false) {
						    return false;
						}

						$block = Enterprise_PageCache_Helper_Url::replaceUenc($block);
						$this->_applyToContent($content, $block);
						return true;
						```
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
						### How containers generate the `cacheId`
						```php
						// Enterprise_PageCache_Model_Container_Welcome::_getCacheId()
						return 'CONTAINER_WELCOME_' . md5($this->_placeholder->getAttribute('cache_id') . $this->_getIdentifier());

						// Enterprise_PageCache_Model_Container_Welcome::_getIdentifier()
						$cacheId = $this->_getCookieValue(Enterprise_PageCache_Model_Cookie::COOKIE_CUSTOMER, '')
						    . '_'
						    . $this->_getCookieValue(Enterprise_PageCache_Model_Cookie::COOKIE_CUSTOMER_LOGGED_IN, '')
						    . '_'
						    . $this->_getCookieValue(Enterprise_PageCache_Model_Cookie::PERSISTENT_COOKIE_NAME, '');
						return $cacheId;
						```
						</script>
					</section>
				</section>

				<!-- 5. How Does It Get There In The First Place? -->
				<section>
					<section data-markdown>
						<script type="text/template">
							## But How Does It Get There In The First Place?
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
							### Before the front controller sends the response...
							```xml
							<!-- app/code/core/Enterprise/PageCache/etc/config.xml -->
							<controller_front_send_response_before>
							    <observers>
							        <enterprise_pagecache>
							            <class>enterprise_pagecache/observer</class>
							            <method>cacheResponse</method>
							        </enterprise_pagecache>
							    </observers>
							</controller_front_send_response_before>
							```
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
							### What the `Observer` does...
							```php
							// Enterprise_PageCache_Model_Observer::cacheResponse()
							if (!$this->isCacheEnabled()) {
							    return $this;
							}
							$frontController = $observer->getEvent()->getFront();
							$request = $frontController->getRequest();
							$response = $frontController->getResponse();
							$this->_processor->processRequestResponse($request, $response);
							return $this;
							```
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
							### How `Enterprise_PageCache` processes the `RequestResponse`...
							```php
							if ($this->canProcessRequest($request)) {
							    $processor = $this->getRequestProcessor($request);
							    if ($processor && $processor->allowCache($request)) {
							        $this->setMetadata('cache_subprocessor', get_class($processor));

							        $cacheId = $this->prepareCacheId($processor->getPageIdInApp($this));
							        $content = $processor->prepareContent($response);

							        $contentSize = strlen($content);
							        $currentStorageSize = (int) $cacheInstance->load(self::CACHE_SIZE_KEY);

							        $maxSizeInBytes = Mage::getStoreConfig(self::XML_PATH_CACHE_MAX_SIZE) * 1024 * 1024;

							        if ($currentStorageSize >= $maxSizeInBytes) {
							            Mage::app()->getCacheInstance()->invalidateType('full_page');
							            return $this;
							        }

							        $cacheInstance->save($content, $cacheId, $this->getRequestTags());

							        $cacheInstance->save(
							            $currentStorageSize + $contentSize,
							            self::CACHE_SIZE_KEY,
							            $this->getRequestTags()
							        );
							        $this->_saveMetadata();
							    }
							}
							```
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
							### How `Enterprise_PageCache` determines if it `canProcessRequest`...
							```php
							// Enterprise_PageCache_Model_Processor::canProcessRequest()
							$res = $this->isAllowed();
							$res = $res && Mage::app()->useCache('full_page');
							if ($request->getParam('no_cache')) {
							    $res = false;
							}

							if ($res) {
							    $maxDepth = Mage::getStoreConfig(self::XML_PATH_ALLOWED_DEPTH);
							    $queryParams = $request->getQuery();
							    unset($queryParams[Enterprise_PageCache_Model_Cache::REQUEST_MESSAGE_GET_PARAM]);
							    $res = count($queryParams)<=$maxDepth;
							}
							if ($res) {
							    $multicurrency = Mage::getStoreConfig(self::XML_PATH_CACHE_MULTICURRENCY);
							    if (!$multicurrency && !empty($_COOKIE['currency'])) {
							        $res = false;
							    }
							}
							return $res;
							```
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
							### How `Enterprise_PageCache` determines if it `isAllowed`...
							```php
							// Enterprise_PageCache_Model_Processor::isAllowed()
							if (!$this->_requestId) {
							    return false;
							}
							if (isset($_COOKIE['NO_CACHE'])) {
							    return false;
							}
							if (isset($_GET['no_cache'])) {
							    return false;
							}
							if (isset($_GET[Mage_Core_Model_Session_Abstract::SESSION_ID_QUERY_PARAM])) {
							    return false;
							}
							if (!Mage::app()->useCache('full_page')) {
							    return false;
							}

							return true;
							```
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
							### How `Enterprise_PageCache` gets the `_requestProcessor`...
							```php
							// Enterprise_PageCache_Model_Processor::getRequestProcessor()
							$configuration = Mage::getConfig()->getNode(self::XML_NODE_ALLOWED_CACHE);
							$module = $request->getModuleName();
							$action = $request->getActionName();
							if (strtolower($action) == self::NOT_FOUND_ACTION && isset($configuration['_no_route'])) {
							    $model = $configuration['_no_route'];
							} elseif (isset($configuration[$module])) {
							    $model = $configuration[$module];
							    $controller = $request->getControllerName();
							    if (is_array($configuration[$module]) && isset($configuration[$module][$controller])) {
							        $model = $configuration[$module][$controller];
							        if (is_array($configuration[$module][$controller])
							                && isset($configuration[$module][$controller][$action])) {
							            $model = $configuration[$module][$controller][$action];
							        }
							    }
							}
							if (isset($model) && is_string($model)) {
							    $this->_requestProcessor = Mage::getModel($model);
							}
							```
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
							### `_requestProcessor`s that ship with `Enterprise_PageCache`.
							```xml
							<!-- app/code/core/Enterprise/PageCache/etc/config.xml -->
							<cache>
							    <requests>
							        <_no_route>enterprise_pagecache/processor_noroute</_no_route>
							        <cms>enterprise_pagecache/processor_default</cms>
							        <catalog>
							            <category>
							                <view>enterprise_pagecache/processor_category</view>
							            </category>
							        </catalog>
							        <catalog>
							            <product>
							                <view>enterprise_pagecache/processor_product</view>
							            </product>
							        </catalog>
							    </requests>
							</cache>
							```
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
							### The `_requestProcessor` has a say (again)
							```php
							// Enterprise_PageCache_Model_Processor_Default::allowCache()
							foreach ($this->_noCacheGetParams as $param) {
							    if (!is_null($request->getParam($param, null))) {
							        $this->_allowCache = false;
							        return $this->_allowCache;
							    }
							}
							if (Mage::getSingleton('core/session')->getNoCacheFlag()) {
							    $this->_allowCache = false;
							    return $this->_allowCache;
							}
							$this->_allowCache = true;
							```
						</script>
					</section>
				</section>

				<!-- 6. How Do We Track It? -->
				<section>
					<section data-markdown>
						<script type="text/template">
							## How Do We Track It?
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
							### I built a (free) module
							<img
								src="images/Mpchadwick_PageCacheHitRate.png"
								style="width: 70%; height: auto">
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
							### Three Types of Responses...
							<ul>
							<li class="fragment">**Hits** - The document and all containers could be pulled from cache.</li>
							<li class="fragment">**Partial Hits** - The document could be pulled from cache, however there were containers that needed additional processing.</li>
							<li class="fragment">**Misses** - The document could not be pulled from cache.</li>
							</ul>
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
							### Tracking Hits With A `requestProcessor`
							```php
							// Mpchadwick_PageCacheHitRate_Model_Processor::extractContent()
							if (!$content) {
							    // Bail, this is a miss
							    return $content;
							}

							// This is a hit, track it
							```
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
							### Tracking Partials and Misses with an `Observer`
							```xml
							<!-- app/code/community/Mpchadwick/PageCacheHitRate/etc/config.xml -->
							<controller_front_send_response_before>
							    <observers>
							        <mpchadwick_pagecachehitrate>
							            <class>Mpchadwick_PageCacheHitRate_Model_Observer</class>
							            <method>handleControllerFrontSendResponseBefore</method>
							        </mpchadwick_pagecachehitrate>
							    </observers>
							</controller_front_send_response_before>
							```
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
							### Executing the track
							```php
							// Mpchadwick_PageCacheHitRate_Model_Observer::handleControllerFrontSendResponseBefore()
							$paramProvider = Mage::getModel('mpchadwick_pagecachehitrate/tracker_paramProvider');
							$type = $this->type();
							$params = $paramProvider->baseParams(true) + array(
							    'type' => $type,
							    'route' => $this->trackerRoute(),
							);

							$factory = Mage::getModel('mpchadwick_pagecachehitrate/trackerFactory');
							foreach ($trackers->asArray() as $alias => $data) {
							    $tracker = $factory->build($data['class']);
							    $tracker->track('RequestResponse', $params, $alias);

							    // Track any container misses for a partial cache response
							    $trackContainerMisses = (string)$config->get('track_container_misses');
							    if ($type === 'partial' && $trackContainerMisses) {
							        unset($params['type']);
							        $tracker->trackContainerMisses($params);
							    }
							}
							```
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
							### Partial Hit or Miss?
							```php
							// Mpchadwick_PageCacheHitRate_Model_Observer::type()
							$request = Mage::app()->getRequest();

							if ($request->getModuleName() === 'pagecache' &&
							    $request->getControllerName() === 'request' &&
							    $request->getActionName() === 'process'
							) {
							    return 'partial';
							} else {
							    return 'miss';
							}
							```
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
							### Tracking Container Misses
							```php
							// Mpchadwick_PageCacheHitRate_Model_Tracker_Abstract::trackContainerMisses()
							$containers = Mage::registry('cached_page_containers');

							foreach ($containers as $container) {
							    $this->track('ContainerMiss', $params + array(
							        'container' => get_class($container),
							    ));
							}
							```
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
							### Dimensions to Track
							```php
							Mpchadwick_PageCacheHitRate_Model_Tracker_ParamProvider::baseParams()
							return array(
							    'url' => $this->getUrl($originalRequest),
							    'ip' => Mage::app()->getRequest()->getClientIp(),
							    'hostname' => gethostname(),
							    'customerGroup' => $this->getCustomerGroup(),
							    'userAgent' => $this->userAgent,
							    'isBot' => $this->isBot,
							);
							```
						</script>
					</section>
				</section>
				<section>
					<section data-markdown>
						<script type="text/template">
						## Where Should We Keep Track?
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
							### What are out options?
							<ul>
								<li class="fragment">**File** - Useful for local profiling / review. Not intended for long term production use.</li>
								<li class="fragment">**New Relic** - SaaS monitoring tool. Capable of storing high cardinality data. **Insights not currently hooked up to alerting suite**</li>
								<li class="fragment">**Redis** - Temporary storage intended to be scraped and stored elsewhere in time series.</li>
								<li class="fragment">**Other** - `Mpchadwick_PageCacheHitRate` allows you to keep track of you hit rate however you'd like. Add your own tracker by implementing `Mpchadwick_PageCacheHitRate_Model_TrackerInterface`.</li>
							</ul>
						</script>
					</section>
					<section data-markdown>
						<script type="text/template">
							### Open Source Time Series Databases
							<ul>
								<li class="fragment">**InfluxDB**
									<ul>
										<li class="fragment">HTTP endpoint accepts writes (and other queries)</li>
										<li class="fragment">Measurements, tags and fields</li>
										<li class="fragment">Need to be mindful of series cardinality</li>
									</ul>
								</li>
								<li class="fragment">**Prometheus**
									<ul>
										<li class="fragment">Sends HTTP request to pull in metrics from "targets"</li>
										<li class="fragment">Metrics, labels and values</li>
										<li class="fragment">Also need to be mindful of series cardinality</li>
									</ul>
								</li>
							</ul>
						</script>
					</section>
				</section>
			</div>
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>
			// More info https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				history: true,

				// More info https://github.com/hakimel/reveal.js#dependencies
				dependencies: [
					{ src: 'plugin/markdown/marked.js' },
					{ src: 'plugin/markdown/markdown.js' },
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
				]
			});
		</script>
	</body>
</html>
